# レポートアシスト - 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
**レポートアシスト（Report Assist）**

### 1.2 目的
AIを活用してレポート作成を効率化し、ユーザーが指定したテーマ・スタイル・構成に基づいて高品質なレポートを生成する支援ツールの開発

### 1.3 技術スタック
- **フロントエンド**: Next.js 14+ (TypeScript) + App Router
- **AIエージェント**: Mastra Framework
- **MCPサーバー**: context7, mastra-docs-server
- **スタイリング**: Tailwind CSS + shadcn/ui
- **状態管理**: Zustand
- **フォーム管理**: React Hook Form + Zod
- **PDFパース**: pdf-parse
- **データベース**: PostgreSQL + Prisma (オプション)

## 2. 機能要件

### 2.1 ステップ1: テーマ設定機能

#### 2.1.1 テーマ入力
- **入力フィールド**: テキストエリア
- **文字数制限**: 256文字以内
- **バリデーション**: 必須入力、文字数チェック
- **プレースホルダー**: 「レポートのテーマを入力してください（例：AIが社会に与える影響について）」
- **リアルタイム文字数カウンター表示**

#### 2.1.2 コンテキスト追加
**PDFアップロード**
- 最大ファイルサイズ: 10MB
- 対応形式: .pdf
- アップロード後のプレビュー表示
- 削除機能
- ドラッグ&ドロップ対応
- アップロード進捗表示

**参考リンク追加**
- 最大5個まで
- URL形式バリデーション
- リンクのタイトル自動取得（Open Graph対応）
- 削除・編集機能
- 重複URLチェック

### 2.2 ステップ2: 詳細設定機能

#### 2.2.1 言語設定
- ラジオボタンまたはセレクトボックス
- デフォルト: 日本語
- オプション: 日本語、英語

#### 2.2.2 文体設定
- ラジオボタンまたはセレクトボックス
- オプション: 常体（だ・である）、敬体（です・ます）
- デフォルト: 常体

#### 2.2.3 口調設定
- セレクトボックス
- オプション: フォーマル、カジュアル、素直、堂々、フレンドリー
- デフォルト: フォーマル

#### 2.2.4 品質設定
- ラジオボタン
- オプション: 高レベル、中レベル、低レベル
- デフォルト: 中レベル
- ツールチップで各レベルの説明表示

#### 2.2.5 目的設定
- テキストエリア
- 256文字以内
- オプション入力
- プレースホルダー: 「レポートの目的や想定読者を記入してください（任意）」

### 2.3 ステップ3: 段落構成・生成機能

#### 2.3.1 自動段落生成
- AIによる初期段落構成の提案
- 各段落のタイトルと概要生成
- 生成中のローディング表示
- 再生成ボタン

#### 2.3.2 段落管理
**追加機能**
- 新規段落の追加（位置指定可能）
- **段落数制限**: 最大10段落まで
- テンプレート選択（序論、本論、結論など）

**削除機能**
- 段落の削除（確認ダイアログ付き）
- 複数選択削除対応

**編集機能**
- タイトル編集（インライン編集）
- 内容プレビュー
- **文字数指定**: 100〜3000文字（100文字単位）
- 段落の説明文編集

**並び替え機能**
- ドラッグ&ドロップで順序変更
- 上下移動ボタン（モバイル対応）

#### 2.3.3 文字数管理
- 各段落の目標文字数表示（最大3000文字/段落）
- **合計文字数制限**: 最大30,000文字
- 合計文字数の自動計算・表示（ヘッダー固定表示）
- 実際の文字数と目標文字数の差分表示
- プログレスバー表示
- 制限超過時の警告表示

#### 2.3.4 レポート生成
- 段落ごとの内容生成
- 一括生成オプション
- プログレスバー表示
- 生成中のキャンセル機能
- 部分再生成機能
- エクスポート機能（Word、PDF、Markdown）

### 2.4 レポート編集機能

#### 2.4.1 マークダウンエディター
- 生成後のレポート編集
- マークダウン形式での直接編集
- リアルタイムプレビュー（分割画面）
- 構文ハイライト
- ツールバー（見出し、太字、斜体、リンク、リスト等）

#### 2.4.2 編集機能
- 元に戻す/やり直し（Undo/Redo）
- 自動保存（30秒ごと）
- 手動保存
- 変更履歴の保持

### 2.5 レポート一覧機能

#### 2.5.1 一覧表示
- 作成済みレポートの一覧表示
- サムネイル/リスト表示切り替え
- ページネーション（20件/ページ）

#### 2.5.2 検索・フィルター
- キーワード検索（タイトル、内容）
- 作成日でのソート
- 更新日でのソート
- ステータスフィルター（下書き、完成）

#### 2.5.3 一覧操作
- レポートの複製
- レポートの削除（確認ダイアログ付き）
- レポートの名前変更
- レポートのプレビュー（モーダル表示）

## 3. データモデル

### 3.1 型定義

```typescript
// 基本的な列挙型
type Language = '日本語' | '英語';
type WritingStyle = '常体' | '敬体';
type Tone = 'フォーマル' | 'カジュアル' | '素直' | '堂々' | 'フレンドリー';
type Quality = '高レベル' | '中レベル' | '低レベル';
type ParagraphStatus = 'draft' | 'generating' | 'completed' | 'error';

// メインのプロジェクトインターフェース
interface ReportProject {
  id: string;
  title: string;
  theme: string;
  context: {
    pdfs: PDFFile[];
    links: ReferenceLink[];
  };
  settings: ReportSettings;
  paragraphs: Paragraph[];
  totalTargetLength: number;
  totalActualLength: number;
  maxTotalLength: 30000;  // 最大文字数
  createdAt: Date;
  updatedAt: Date;
  status: 'draft' | 'in_progress' | 'completed';
  generatedContent?: string;  // マークダウン形式の生成済みコンテンツ
  editedContent?: string;      // 編集後のコンテンツ
}

// 詳細設定
interface ReportSettings {
  language: Language;
  writingStyle: WritingStyle;
  tone: Tone;
  quality: Quality;
  purpose?: string;
}

// 段落
interface Paragraph {
  id: string;
  order: number;
  title: string;
  description: string;
  content: string;
  targetLength: number;  // 最大3000文字
  actualLength: number;
  status: ParagraphStatus;
  error?: string;
  createdAt: Date;
  updatedAt: Date;
}

// 段落制限
interface ParagraphConstraints {
  maxParagraphs: 10;
  maxLengthPerParagraph: 3000;
  minLengthPerParagraph: 100;
  maxTotalLength: 30000;
}

// PDFファイル
interface PDFFile {
  id: string;
  name: string;
  size: number;
  url: string;
  content?: string; // パース後のテキスト
  uploadedAt: Date;
}

// 参考リンク
interface ReferenceLink {
  id: string;
  url: string;
  title?: string;
  description?: string;
  favicon?: string;
  addedAt: Date;
}
```

## 4. API設計

### 4.1 エンドポイント一覧

```typescript
// レポートプロジェクト関連
POST   /api/projects                  // 新規プロジェクト作成
GET    /api/projects                  // プロジェクト一覧取得
GET    /api/projects/:id              // プロジェクト取得
PUT    /api/projects/:id              // プロジェクト更新
DELETE /api/projects/:id              // プロジェクト削除
POST   /api/projects/:id/duplicate    // プロジェクト複製

// テーマ・コンテキスト関連
POST   /api/projects/:id/theme        // テーマ設定
POST   /api/projects/:id/upload-pdf   // PDF アップロード
DELETE /api/projects/:id/pdf/:pdfId   // PDF 削除
POST   /api/projects/:id/add-link     // リンク追加
DELETE /api/projects/:id/link/:linkId // リンク削除

// 設定関連
PUT    /api/projects/:id/settings     // 設定更新

// 段落関連
POST   /api/projects/:id/generate-structure  // 段落構成自動生成
POST   /api/projects/:id/paragraphs         // 段落追加
PUT    /api/projects/:id/paragraphs/:pid    // 段落更新
DELETE /api/projects/:id/paragraphs/:pid    // 段落削除
PUT    /api/projects/:id/paragraphs/reorder // 段落並び替え

// レポート生成・編集
POST   /api/projects/:id/generate           // レポート生成
POST   /api/projects/:id/generate/:pid      // 特定段落生成
PUT    /api/projects/:id/content            // レポート内容編集
POST   /api/projects/:id/export             // エクスポート

// 一覧・検索
GET    /api/projects/search                 // レポート検索
```

### 4.2 Mastra エージェント設定

```typescript
// mastra.config.ts
import { Mastra } from '@mastra/core';
import { createAgent } from '@mastra/agent';

export const reportAgent = createAgent({
  name: 'ReportAssistant',
  description: 'レポート作成を支援するAIエージェント',
  systemPrompt: `
    あなたは優秀なレポート作成アシスタントです。
    ユーザーが指定したテーマ、文体、口調に従って、
    構造化された高品質なレポートを作成してください。
  `,
  tools: [
    // MCPサーバー統合
    'context7',
    'mastra-docs-server'
  ],
  capabilities: {
    structureGeneration: true,
    contentGeneration: true,
    styleAdaptation: true,
    multiLanguage: true
  }
});
```

## 5. UI/UXデザイン

### 5.1 画面構成

#### 5.1.1 ステップ型ウィザード
- 3ステップの横型プログレスバー
- 各ステップの完了状態表示
- 前後ステップへの移動可能

#### 5.1.2 レスポンシブデザイン
- デスクトップ: 1200px幅を基準
- タブレット: 768px〜1199px
- モバイル: 767px以下

#### 5.1.3 カラースキーム
```css
:root {
  --primary: #3B82F6;      /* Blue-500 */
  --secondary: #10B981;    /* Emerald-500 */
  --accent: #8B5CF6;       /* Violet-500 */
  --background: #FFFFFF;
  --foreground: #111827;   /* Gray-900 */
  --muted: #6B7280;        /* Gray-500 */
  --border: #E5E7EB;       /* Gray-200 */
}
```

### 5.2 コンポーネント構成

```typescript
// コンポーネントツリー
- App
  ├── Layout
  │   ├── Header
  │   └── Navigation
  ├── Pages
  │   ├── Dashboard (レポート一覧)
  │   │   ├── SearchBar
  │   │   ├── FilterOptions
  │   │   ├── ReportList
  │   │   │   └── ReportCard
  │   │   └── Pagination
  │   ├── ReportEditor (新規作成/編集)
  │   │   ├── StepIndicator
  │   │   ├── Step1: ThemeInput
  │   │   │   ├── ThemeTextarea
  │   │   │   ├── PDFUploader
  │   │   │   └── LinkManager
  │   │   ├── Step2: SettingsForm
  │   │   │   ├── LanguageSelector
  │   │   │   ├── StyleSelector
  │   │   │   ├── ToneSelector
  │   │   │   ├── QualitySelector
  │   │   │   └── PurposeTextarea
  │   │   └── Step3: ParagraphEditor
  │   │       ├── StructureGenerator
  │   │       ├── ParagraphList
  │   │       │   └── ParagraphItem
  │   │       ├── WordCountDisplay
  │   │       ├── GenerateButton
  │   │       └── ExportMenu
  │   └── ReportViewer (閲覧/編集)
  │       ├── MarkdownEditor
  │       ├── PreviewPane
  │       ├── Toolbar
  │       └── SaveIndicator
  └── Components
      ├── Common
      │   ├── Button
      │   ├── Modal
      │   ├── Toast
      │   └── LoadingSpinner
      └── Icons
```